<!DOCTYPE html>
<#assign ctx=request.contextPath>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;multipart/form-data;charset=UTF-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1" /> 
<title>照片上传</title>
<link href="http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
<link href="http://cdn.bootcss.com/bootstrap-fileinput/4.3.8/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
<script src="${ctx}/js/jquery.js"></script>
<script src="${ctx}/js/jquery.mobile-1.4.5.js"></script> 
<script type="text/javascript" src="${ctx}/js/jquery.form.js"></script>
<script href="http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js" type="text/javascript"></script>
<script src="http://cdn.bootcss.com/bootstrap-fileinput/4.3.8/js/fileinput.min.js" type="text/javascript"></script>
<script src="http://res2.wx.qq.com/open/js/jweixin-1.4.0.js"></script>

<style type="text/css">
*{margin:0;padding:0;}
input,button,select,textarea{outline:none;}
.ui-loader-default{ display:none}  
.ui-mobile-viewport{ border:none;}  
.ui-page {padding: 0; margin: 0; outline: 0}   
ul{list-style-type:none;}

.main-page{
	width:94vw;
	margin: 0 auto;
}
.main-page .header{
	padding-bottom:4vw;
	padding-top:4vw;
	height: 14vw;
	line-height: 6vw;
	font-size: 4vw;
}
.main-page .header>span{
	display: inline-block;
    float: right;
    width: 22vw;
    height: 8vw;
    line-height: 8vw;
    font-size: 5vw;
    background-color: #2196F3;
    border-radius: 1vw;
    color: white;
    text-align: center;
}

/*外层div*/
.input-file-box{
	border: 1px solid gray;
    width: 45vw;
    height: 30vw;
    display:inline-block;
    position: relative;
    text-align: center;
    border-radius: 8px;
}
/*文字描述*/
.input-file-box > span{
	display: block;
    width: 100px;
    height: 30px;
    position: absolute;
    top: 0px;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
    color: gray;
}
/*input框*/
.input-file-box #uploadfile{
	opacity: 0;
    width: 100%;
    height: 30vw;
    cursor: pointer;
}	
	
	

</style>

<script type="text/javascript">

//将触摸动作赋值到全局变量，用于下面判断
var control = "touchstart";
var loosen  = "touchend";
//用于存放图片
var serverIds = [];
var surplusPaper = ${defaultPaper}<=0?1:${defaultPaper};


function getJsSdkConfig(){
	var lUrl = encodeURIComponent(window.location.href);
	
	$.ajax({
			type: "POST",
	        url: "${ctx}/main/getJsSDK",
	        data:"lUrl="+lUrl,
	        async: false,
	        dataType:"json",
	        success: function (config) {
	        	
	        	if(config != null){
	        		wx.config({
	        	        debug : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
	        	        appId : config.appId, // 必填，appID公众号的唯一标识
	        	        timestamp : config.timestamp, // 必填，生成签名的时间戳
	        	        nonceStr : config.nonceStr, // 必填，生成签名的随机串
	        	        signature : config.signature,// 必填，签名，见附录1
	        	        jsApiList : [ 'scanQRCode' ,'onMenuShareTimeline',"chooseImage","uploadImage"]
	        	    // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
	        	    }); 
	        	}
	        }	
				
		});  
	
}

function preview(){
	
	$(".previewDiv").on("click",function(){
		//找到父辈，再获取所有子辈名为photoDiv的div
		var divs = $(this).parent().parent().children(".photoDiv");
		var urls = [];
		$(divs).each(function(i){
			var url = $(this).find("img").attr("src");
			
			urls.push(url);
		})
		
		wx.previewImage({
			current: urls[$(this).index()] , 
			urls: urls 
		});
		
	})
	
	
}

Array.prototype.remove=function(obj){ 
for(var i =0;i <this.length;i++){ 
var temp = this[i]; 
if(!isNaN(obj)){ 
temp=i; 
} 
if(temp == obj){ 
for(var j = i;j <this.length;j++){ 
this[j]=this[j+1]; 
} 
this.length = this.length-1; 
} 
} 
} 

function delPhoto(){
	
	if(confirm("确定删除该照片吗？")){
		$(".photoDiv").on("click",function(){
			
			serverIds.remove($(this).index());
			$(this).remove();
			addSerial();　　
		})
	}
	
}
function addSerial(){
	$(".serial").remove();
	$("#img-box>div").each(function () {
		var serial = $(this).index()+1;
		var span = document.createElement('span');
		span.style.fontSize = "4vw";
		span.style.width = "5vw";
		span.style.height = "5vw";
		span.style.lineHeight = "5vw";
		span.style.left = "2vw";
		span.style.bottom = "2vw";
		span.style.textAlign = "center";
		span.style.border = "1px solid #607D8B";
		span.style.marginRight = "4px";
		span.classList.add("serial"); 
		span.style.position = "absolute";
		span.style.borderRadius = "5vw";
		span.innerHTML = serial;
		$(this).append(span);

	})
}
function uploadImage(localIds){
	
	if(localIds.length == 0){
		//所选图全部上传成功了
		HuiFang.Funtishi("上传完成",1);
		
	}else{
		HuiFang.Funtishi("照片上传中",0);
		var src = localIds.pop();
		//var src = "http://move.ehai.xyz/photo/gB1m82132021/e9096742-c050-4c93-a688-9a22229de8ca.jpg";
		var serverId;
		
		var div = document.createElement('div');
			div.style.width = "45vw";
			div.style.height = "40vw";
			div.style.display = "inline-block";
			div.style.marginRight = "4px";
			div.classList.add("photoDiv"); 
			div.style.position = "relative";
		var photo=document.createElement('div');
			photo.style.border = "1px solid gray";
			photo.style.width = "45vw";
			photo.style.height = "30vw";
			photo.style.textAlign = "center";
			photo.style.borderRadius = "8px";
			photo.style.display = "inline-block";
			photo.style.marginBottom = "4px";
			photo.style.overflow = "hidden";
			photo.classList.add("previewDiv"); 
			photo.setAttribute('id','previewDiv');
			photo.setAttribute("onmousedown","preview()");
			//photo.innerHTML='<img style="position: relative" id="myImg" src="'+src+'" />';
		var img = document.createElement('img');
			img.style.position = "relative"; 
			img.src = src;
			photo.appendChild(img);
		var del = document.createElement('div');		
	    	del.style.width = "12vw";
	    	del.style.height = "6vw";
	    	del.style.lineHeight = "6vw";
	    	del.style.fontSize = "4vw";
	    	del.style.textAlign = "center";
	    	del.style.backgroundColor = "rgba(3, 169, 244, 0.57)";
	    	del.style.color = "#F44336";
	    	del.style.borderRadius = "1vw";
	    	del.style.marginLeft = "33vw";
	    	del.setAttribute("onmousedown","delPhoto()");
	    	del.innerHTML='删除';
	    	div.appendChild(photo);
	    	div.appendChild(del);
			document.getElementById("img-box").appendChild(div);
		//调整照片取中间部分
	   	var image = new Image();
			image.src = src;
	    var realWidth = 0;//储存图片实际宽度
	    var realHeight = 0;//储存图片实际高度
	    var o = document.getElementById("previewDiv");
	    var h = o.offsetHeight; //高度
	    var w = o.offsetWidth; //宽度
	    image.onload = function () {
	        realWidth = image.width;//获取图片实际宽度
	        realHeight = image.height;//获取图片实际高度
	        //让img的宽高相当于图片实际宽高的等比缩放，然后再偏移
	        if (realWidth > realHeight){
	            img.width = (h/realHeight)*realWidth;//等比缩放宽度
	            img.height = h;//跟div高度一致
	            img.style.left = '-' + ((h/realHeight)*realWidth-w)/2 + 'px';//设置图片相对自己位置偏移为img标签的宽度-高度的一半
	        }else if (realWidth < realHeight){
	            img.width =w ;//跟div高度一致
	            img.height = (w/realWidth)*realHeight;//等比缩放高度
	            img.style.top = '-' + ((w/realWidth)*realHeight-h)/2 + 'px';//设置图片相对自己位置偏移为img标签的高度-宽度的一半
	        }else {
	            img.width =w ;
	            img.height = h;
	        }

	    };
			
		wx.uploadImage({
			localId: src, // 需要上传的图片的本地ID，由chooseImage接口获得
			isShowProgressTips: 0, // 默认为1，显示进度提示
			success: function (res) {
				serverId = res.serverId;
				serverIds.push(serverId);
				uploadImage(localIds);
			}
		});
		//每次上传完成，重新排一次序号
		addSerial();
	}
	
	
	
	
}

//判断设备
var os = function() {  
     var ua = navigator.userAgent,  
     isWindowsPhone = /(?:Windows Phone)/.test(ua),  
     isSymbian = /(?:SymbianOS)/.test(ua) || isWindowsPhone,   
     isAndroid = /(?:Android)/.test(ua),   
     isFireFox = /(?:Firefox)/.test(ua),   
     isChrome = /(?:Chrome|CriOS)/.test(ua),  
     isTablet = /(?:iPad|PlayBook)/.test(ua) || (isAndroid && !/(?:Mobile)/.test(ua)) || (isFireFox && /(?:Tablet)/.test(ua)),  
     isPhone = /(?:iPhone)/.test(ua) && !isTablet,  
     isPc = !isPhone && !isAndroid && !isSymbian;  
     return {  
          isTablet: isTablet,  
          isPhone: isPhone,  
          isAndroid : isAndroid,  
          isPc : isPc  
     };  
}();  

$(document).on("pagecreate","#page",function(){
	
	
	getJsSdkConfig();
	//判断如果是pc端则将触摸动作改为点击动作
	if(os.isPc){
		control = "mousedown";
		loosen  = "mouseup";
	}
	
	
  	$("#uploadPhoto").on(control,function(){
  		HuiFang.Funtishi("正在生成订单",0);
  		$(this).css("background-color","#F44336");
  		
  	})
  	
  	$("#uploadPhoto").on(loosen,function(){     
		 
		$(this).css("background-color","#2196F3");
		
		if(surplusPaper>serverIds.length){
			HuiFang.Funtishi("最少打印"+surplusPaper+"张",0);
		}else{
			
			var formData = new FormData();
			
			formData.append("fileInput", serverIds);
			formData.append("goodsId", ${goodsId});
			formData.append("typeId", ${typeId});
			
			$.ajax({
	            type: "POST",			
	                url: "${ctx}/main/uploadPhoto",
	                data:formData,
	                async: false,
	                dataType:"text",
	                //这两个设置项必填
	                contentType: false,
	                processData: false,
	                success: function (data) {
	                	
	                	if(data != "error"){
	        				
	        				setTimeout(function(){
	        					window.location.href="toOrder?orderId="+data;
	                		}, 1000);
	        				
	        			}
	                },
	              	//失败时的函数
	        		error:function(){
	        			HuiFang.Funtishi("照片上传失败",1)
	        		}	
	          });
		}
		
		
		
		
	})
	
	
	$("#upImg").on(loosen,function(){     
		
	    wx.chooseImage({
            count: 9, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
              var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
              uploadImage(localIds);
              
            } 
        });
		
	})
	
	
	
	
	
	
	
	
	
});

$('#uploadfile').fileinput({
    language: 'fr',
    uploadUrl: '#',
    allowedFileExtensions : ['jpg', 'png','gif'],
    'elErrorContainer': '#errorBlock'
});

var HuiFang={
		m_tishi :null,//全局变量 判断是否存在div,
		//提示div 等待2秒自动关闭
		Funtishi: function (content,type) {
			if (HuiFang.m_tishi == null) {
				HuiFang.m_tishi = '<div class="xiaoxikuang none" id="app_tishi" style="z-index:9999;left: 15%;width:70%;position: fixed;background:none;bottom:40%;"> <p class="app_tishi" style="background: none repeat scroll 0 0 #000; text-shadow:none;border-radius: 2vw;color: #fff; margin: 0 auto;padding: 3vw;text-align: center;width: 70%;opacity: 0.8; font-family:Microsoft YaHei;letter-spacing: 1vw;font-size: 5vw;"></p></div>';
				$(document.body).append(HuiFang.m_tishi);
			}
			$("#app_tishi").show();
			$(".app_tishi").html(content);
			if (type == 1){
				setTimeout('$("#app_tishi").fadeOut()', 1500);
			}
		},
}


	
	

</script>

</head>
<body>
	<div data-role="page" id="page">
		<div data-role="main" class="main-page">
		
    	<div class="main-page">
    	<form action="${ctx}/photo/uploadPhoto" style="display:none;"  method="POST" id="fileForm"
		enctype="multipart/form-data">
			<input type="hidden" name="goodsId" id="orderId" value="${goodsId}"/>
			<input type="hidden" name="orderId" id="typeId" value="${typeId}"/>
			<input type="hidden" name="orderId" id="defaultPaper" value="${defaultPaper}"/>
			
		　　
		</form>
    	<div class="header">
    		影集
    		<span id="uploadPhoto">下一步</span>
    	</div>
    	<div id="img-box"></div>
    	<div class="input-file-box" id="upImg">
    	
			<span>点击上传图片</span>
			
			
		</div>
		
    	
    	
    	
    	</div>
    	</div>
    </div>
<script>
    
 
</script>
</body>
</html>