<!DOCTYPE html>
<#assign ctx=request.contextPath>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html;multipart/form-data;charset=UTF-8" />  
	<meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <meta name="referrer" content="never">
	<link rel="stylesheet" type="text/css" href="${ctx}/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="${ctx}/css/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="${ctx}/css/style.css" />
    <link rel="stylesheet" type="text/css" href="${ctx}/css/admin-right.css" />
    <script type="text/javascript" src="${ctx}/js/jquery.js"></script>
    <script type="text/javascript" src="${ctx}/js/jquery-migrate-1.2.1.js"></script>
   	<script src="${ctx}/js/jquery.xml2json.js"></script>
   	<script src="${ctx}/js/tinymce/tinymce.min.js"></script>
  	
    <!-- 弹窗 -->
    <script src="${ctx}/js/artDialog-6.0.2/dist/dialog-min.js"></script>
	<link rel="stylesheet" href="${ctx}/js/artDialog-6.0.2/css/ui-dialog.css">
    <style type="text/css">
    	div{
    		margin-left: 24px;
    	}
    	button{
   		    width: 80px;
		    height: 30px;
		    margin-top: -50px;
		    margin-left: 680px;
		    background-color: #2196F3;
		    color: white;
		    font-size: 16px;
		    border-radius: 6px;
    	}
    	#cover{
    		height: 50px;
    	}
    </style>
    
    
    
</head>
<body>
<#if artObject??>
<div style="margin-top: 24px;">标题: <input id="Title" type="text" value="${artObject.Title}"></div>
<input id="ArtID" type="hidden" value="${artObject.ArtID?c}">
<form id="uploadfiles" enctype="multipart/form-data">

	<div id="cover">封面: <input type="file" id="file_input" name="file" multiple/>
		<div id="coverImg" value="${artObject.PhotoCover}" style="background-image: url(&quot;${artObject.PhotoCover}&quot;); width: 200px; height: 180px; -webkit-box-flex: 0; flex: 0 0 auto; background-repeat: no-repeat; background-position: 50% center; background-size: cover; vertical-align: top; position: absolute; left: 640px; top: 30px;"></div>
		<input type="hidden" id="PhotoCover" value="${artObject.PhotoCover}">
	</div>				
</form>
<div>
	文章分类: <select id="CID">
			<#list CIDArray as CIDArray>
				
				<#if CIDArray.CID == artObject.CID>
					<option value="${CIDArray.CID}" selected="selected">${CIDArray.CName}</option>
				<#else>
					<option value="${CIDArray.CID}">${CIDArray.CName}</option>
				</#if>
			</#list>
		</select> 
</div>
<div>



图片位置: <select id="FontType">
			<#if artObject.FontType == 0>
				<option value="0" selected="selected">字上图下</option>
				<option value="1">字下图上</option>
			<#elseif artObject.FontType == 1>
				<option value="0">字上图下</option>
				<option value="1" selected="selected">字下图上</option>
			</#if>
			
		</select> 
权限: <select id="IsRight">
			<#if artObject.IsRight == 0>
				<option value="0" selected="selected">草稿</option>
				<option value="1">公开</option>
				<option value="2">私密</option>
			<#elseif artObject.IsRight == 1>
				<option value="0">草稿</option>
				<option value="1" selected="selected">公开</option>
				<option value="2">私密</option>
			<#elseif artObject.IsRight == 2>
				<option value="0">草稿</option>
				<option value="1">公开</option>
				<option value="2" selected="selected">私密</option>
			</#if>	
		</select> 		
</div>

<textarea style="width: 620px;height: 360px;">
	<#if artObject.FontType == 0>
	<#list artObject.Content as Content>
		<#if Content.text != "">
		<p>${Content.text}</p>
		</#if>
		<#if Content.photo != "">
		<p><img src="${Content.photo}" width="200"alt="" data-mce-selected="1"></p>
		</#if>
	</#list>
	<#elseif artObject.FontType == 1>
	<#list artObject.Content as Content>
		<#if Content.photo != "">
		<p><img src="${Content.photo}" width="200"alt="" data-mce-selected="1"></p>
		</#if>
		<#if Content.text != "">
		<p>${Content.text}</p>
		</#if>
	</#list>
		
	</#if>
</textarea>
<button>提交</button>


<#else>

<div style="margin-top: 24px;">标题: <input id="Title" type="text"></div>
<input id="ArtID" type="hidden" value="0">
<form id="uploadfiles" enctype="multipart/form-data">

	<div id="cover">封面: <input type="file" id="file_input" name="file" multiple/>
	
	</div>				
</form>
<div>
	文章分类: <select id="CID">
			<#list CIDArray as CIDArray>
				<#if CIDArray.CID == 1>
					<option value="${CIDArray.CID}" selected="selected">${CIDArray.CName}</option>
				<#else>
					<option value="${CIDArray.CID}">${CIDArray.CName}</option>
				</#if>
			</#list>
		</select> 
</div>
<div>
图片位置: <select id="FontType">
			<option value="0" selected="selected">字上图下</option>
			<option value="1">字下图上</option>
		</select> 
权限: <select id="IsRight">
			<option value="0">草稿</option>
			<option value="1" selected="selected">公开</option>
			<option value="2">私密</option>
		</select> 		
</div>

<textarea style="width: 620px;height: 360px;"></textarea>
<button>提交</button>
</#if>    
</body>

<script type="text/javascript">
    function transition(textarea){
    	
    	var n = new RegExp(" ","g");
    	var l = new RegExp("&ldquo;","g");
    	var r = new RegExp("&rdquo;","g");
    	var h = new RegExp("&hellip;","g");
    	var m = new RegExp("&mdash;","g");
    	var r2 = new RegExp("&rsquo;","g");
    	
    	textarea = textarea.replace(n,"&nbsp;");
		textarea = textarea.replace(l,"'");
		textarea = textarea.r-                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    eplace(r,""); 
		textarea = textarea.replace(h,"…"); 
		textarea = textarea.replace(m,"—"); 
		textarea = textarea.replace(r2,"’");
		
		return textarea;
    }
    
    $(function(){
    	
    
    	$("button").on("click",function(){
    		var ArtID = $("#ArtID").val();
    		var Title = $("#Title").val();
    		var CID = $("#CID").val();
    		var FontType = $("#FontType").val();
    		var IsRight = $("#IsRight").val();
    		var textarea = tinyMCE.activeEditor.getContent();
    		/* textarea = transition(textarea); */
    		
    		/* var activeEditor = tinymce.activeEditor; 
    		var editBody = activeEditor.getBody(); 
    		activeEditor.selection.select(editBody); 
    		var textarea = activeEditor.selection.getContent( { 'format' : 'text' } ); */
    		
    		var PhotoCover = $("#PhotoCover").val();
    		if(Title == null || Title == ""){
    			alert("标题不能为空");
    		}else if(PhotoCover == null || PhotoCover == ""){
    			alert("封面不能为空");
    		}else if(textarea == null || textarea == ""){
    			alert("内容不能为空");
    		}else{
    			var data = {"ArtID":ArtID,"CID":CID,"Title":Title,"FontType":FontType,"Content":textarea,"IsRight":IsRight,"PhotoCover":PhotoCover};
    			$.ajax({
    				type: "POST",
    		        url: "${ctx}/admin/addArticle",
    		        data:data,
    		        async: false,
    		        dataType:"text",
    		        success: function (code) {
    		        	
    					  if(code == "1"){
    						  
    						  window.location.href = "${ctx}/admin/toArticleList";
    							
    					  }else{
    						  alert(code);
    					  }
    					  
    		        	
    				}	
    		    }); 
    		}
    		
    		
    		
    		
    		
    	})
    	
    	$("#file_input").on("change",function(){
    		var formData = new FormData($( "#uploadfiles" )[0]);
    		$.ajax({
    		      type: "post",
    		      url: "${ctx}/admin/uploadImage",
    		      dataType: "json",
    		      data: formData,
    		      /**  
    		       *必须false才会自动加上正确的Content-Type  
    		       */
    		      contentType : false,
    		      /**  
    		       * 必须false才会避开jQuery对 formdata 的默认处理  
    		       * XMLHttpRequest会对 formdata 进行正确的处理  
    		       */
    		      processData : false,
    		      async : false,//上传文件时取消异步，这样他会等到上传文件成功后才进行后面的操作，才不会报错
    		      success: function(data){//从后端返回数据进行处理
    		       if(data != null){
    		    	   $("#coverImg").remove();
    		    	   $("#PhotoCover").remove();
    		    	   var div = $("<div>");
    		    	   div.attr("id","coverImg");
    		    	   div.css({"background-image":"url('"+data.location+"')", "width":"200px","height":"180px","-webkit-box-flex":"0","-webkit-flex":"0 0 auto","-ms-flex":"0 0 auto","flex":"0 0 auto","background-repeat":"no-repeat","background-position":"50%","background-size":"cover","vertical-align":"top","position":"absolute","left":"640px","top":"30px"});
    		    	   var input = $("<input>");
    		    	   input.attr({"id":"PhotoCover","type":"hidden","value":""+data.location+""});
    		    	   
    		    	   $("#cover").append(div);
    		    	   $("#cover").append(input);
    		       }else{
    		         alert("上传失败！");
    		       }
    		      },
    		      error: function(err) {//提交出错
    		        //$("#msg").html(JSON.stringify(err));//打出响应信息
    		        alert("服务器无响应");
    		       }
    	     });
    		
    	})
    	
    })
    
      tinymce.init({
	    selector: 'textarea',//意思是将TinyMCE插件放入‘textarea’ID为mytextarea的标签里
	    language: 'zh_CN',
	    plugins: [ //配置插件：可自己随意选择，但如果是上传本地图片image和imagetools是必要的
	      'image imagetools'
	    ],
	//工具框，也可自己随意配置
	    toolbar: 'insertfile undo redo | image',       
	    image_advtab: true,
	    table_default_styles: {
	        width: '100%',
	         borderCollapse: 'collapse'
	    },
	    //禁用转移符
	    entity_encoding: "raw",
	    image_title: false, // 是否开启图片标题设置的选择，这里设置否
	    automatic_uploads: true,
	 // 图片异步上传处理函数
	    images_upload_handler: (blobInfo, success, failure) => { 
	        var xhr, formData;
	 
	        xhr = new XMLHttpRequest();
	        xhr.withCredentials = false;
	        xhr.open('POST', '${ctx}/admin/uploadImage');//第一个参数是请求方式，第二个参数是请求地址，我这里配置的是struts的action，如果是其他（PHP等）的可这样配置：xxx.php
	 
	        xhr.onload = function () {
	            var json;
	            if (xhr.status !== 200) {
	                failure('HTTP Error: ' + xhr.status);
	                return;
	            }
	            json = JSON.parse(xhr.responseText);            
	            if (!json || typeof json.location !== 'string') {
	            failure('Invalid JSON: ' + xhr.responseText);
	                return;
	            }
	            success(json.location);
	        };
	 
	        formData = new FormData();
	        formData.append('file', blobInfo.blob());
	        
	        xhr.send(formData);
	    }
	  });
      
      
     
 
    
    </script>

</html>